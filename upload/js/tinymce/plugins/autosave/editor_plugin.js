(function(n){var u="_expires",e="autosave",f=e,i="restoredraft",t=!0,s,o,r=n.util.Dispatcher;n.create("tinymce.plugins.AutoSave",{init:function(u){function l(n){var t={s:1e3,m:6e4};return n=/^(\d+)([ms]?)$/.exec(""+n),(n[2]?t[n[2]]:1)*parseInt(n)}var h=this,c=u.settings;h.editor=u,n.each({ask_before_unload:t,interval:"30s",retention:"20m",minlength:50},function(n,t){t=f+"_"+t,c[t]===s&&(c[t]=n)}),c.autosave_interval=l(c.autosave_interval),c.autosave_retention=l(c.autosave_retention),u.addButton(i,{title:u.getLang("xenforo.restoredraft_desc"),onclick:function(){u.focus(),u.getContent({draft:!0}).replace(/\s|&nbsp;|<\/?p[^>]*>|<br[^>]*>/gi,"").length>0?confirm(u.getLang("xenforo.restoredraft_warning"))&&h.restoreDraft():h.restoreDraft()}}),u.onNodeChange.add(function(){var n=u.controlManager;n.get(i)&&n.setDisabled(i,!h.hasDraft())}),u.onInit.add(function(){u.controlManager.get(i)&&(h.setupStorage(u),setInterval(function(){var t="_statusbar_autosave";if(!u.removed&&(h.storeDraft(),u.nodeChanged(),u.getParam("autosave_display_in_statusbar"))){var i=n.DOM.get(u.id+"_path_row"),r=u.getContent();i&&r.length>u.settings.autosave_minlength&&($("#"+u.id+t).length||n.DOM.add(i.parentNode,"div",{id:u.id+t,"class":"statusbar_autosave"},u.getLang("xenforo.autosave_statusbar_msg")),$("#"+u.id+t).slideUp(300).fadeIn("slow").delay(1e3).fadeOut(300))}},c.autosave_interval))}),h.onStoreDraft=new r(h),h.onRestoreDraft=new r(h),h.onRemoveDraft=new r(h),o||(window.onbeforeunload=n.plugins.AutoSave._beforeUnloadHandler,o=t)},getInfo:function(){return{longname:"Auto save",author:"Moxiecode Systems AB",authorurl:"http://tinymce.moxiecode.com",infourl:"http://wiki.moxiecode.com/index.php/TinyMCE:Plugins/autosave",version:n.majorVersion+"."+n.minorVersion}},getExpDate:function(){return new Date(+new Date+this.editor.settings.autosave_retention).toUTCString()},setupStorage:function(i){var e=this,r=f+"_test",u="OK";e.key=f+i.id,n.each([function(){if(localStorage&&(localStorage.setItem(r,u),localStorage.getItem(r)===u))return localStorage.removeItem(r),localStorage},function(){if(sessionStorage&&(sessionStorage.setItem(r,u),sessionStorage.getItem(r)===u))return sessionStorage.removeItem(r),sessionStorage},function(){if(n.isIE)return i.getElement().style.behavior="url('#default#userData')",{autoExpires:t,setItem:function(n,t){var r=i.getElement();r.setAttribute(n,t),r.expires=e.getExpDate();try{r.save("TinyMCE")}catch(u){}},getItem:function(n){var t=i.getElement();try{return t.load("TinyMCE"),t.getAttribute(n)}catch(r){return null}},removeItem:function(n){i.getElement().removeAttribute(n)}}},],function(n){try{if(e.storage=n(),e.storage)return!1}catch(t){}})},storeDraft:function(){var n=this,f=n.storage,i=n.editor,r,t;if(f){if(!f.getItem(n.key)&&!i.isDirty())return;t=i.getContent({draft:!0}),t.length>i.settings.autosave_minlength&&(r=n.getExpDate(),n.storage.autoExpires||n.storage.setItem(n.key+u,r),n.storage.setItem(n.key,t),n.onStoreDraft.dispatch(n,{expires:r,content:t}))}},restoreDraft:function(){var n=this,i=n.storage,t;i&&(t=i.getItem(n.key),t&&(n.editor.setContent(t),n.onRestoreDraft.dispatch(n,{content:t})))},hasDraft:function(){var n=this,i=n.storage,f,r;if(i&&(r=!!i.getItem(n.key),r)){if(n.storage.autoExpires||(f=new Date(i.getItem(n.key+u)),+new Date<f.getTime()))return t;n.removeDraft()}return!1},removeDraft:function(){var t=this,n=t.storage,r=t.key,i;n&&(i=n.getItem(r),n.removeItem(r),n.removeItem(r+u),i&&t.onRemoveDraft.dispatch(t,{content:i}))},static:{_beforeUnloadHandler:function(){var i;return n.each(tinyMCE.editors,function(n){(n.plugins.autosave&&n.plugins.autosave.storeDraft(),n.getParam("fullscreen_is_enabled"))||!i&&n.isDirty()&&n.getParam("autosave_ask_before_unload")&&(i=n.getLang("xenforo.autosave_unload_msg"))}),i}}}),n.PluginManager.add(e,n.plugins.AutoSave)})(tinymce);